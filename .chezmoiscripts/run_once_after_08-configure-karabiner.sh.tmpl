#!/bin/bash

{{ if eq .chezmoi.os "darwin" -}}
echo "Configuring Karabiner-Elements..."

# Wait for Karabiner-Elements to be installed
if ! command -v '/Applications/Karabiner-Elements.app/Contents/MacOS/Karabiner-Elements' &> /dev/null; then
    echo "Waiting for Karabiner-Elements to be installed..."
    sleep 2
fi

# Start Karabiner-Elements if not running
if ! pgrep -x "karabiner_console_user_server" > /dev/null; then
    echo "Starting Karabiner-Elements..."
    open -a "Karabiner-Elements"
    sleep 3
fi

# Check if configuration was applied
if [ -f "$HOME/.config/karabiner/karabiner.json" ]; then
    echo "✓ Karabiner-Elements configuration applied"
    echo ""
    echo "Keyboard shortcuts configured:"
    echo "  Caps Lock + C → Calendar"
    echo "  Caps Lock + F → Firefox"
    echo "  Caps Lock + S → Slack"
    echo "  Caps Lock + V → Visual Studio Code"
    echo "  Caps Lock + O → Obsidian"
    echo "  Caps Lock + M → Firefox Tab 1"
    echo "  Caps Lock + T → Firefox Tab 2"
    echo "  Option + Space → Show/Hide Warp Terminal"
    echo ""
    echo "Note: You may need to grant accessibility permissions to Karabiner-Elements"
    echo "in System Preferences → Security & Privacy → Privacy → Accessibility"
else
    echo "Error: Karabiner configuration not found"
fi

{{ else -}}
echo "Karabiner-Elements is only supported on macOS"
{{ end -}}