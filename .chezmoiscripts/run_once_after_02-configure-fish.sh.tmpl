#!/bin/bash

set -eufo pipefail

# Add fish to valid shells if not already added
if ! grep -q "$(which fish)" /etc/shells; then
    echo "Adding fish to /etc/shells..."
    echo "$(which fish)" | sudo tee -a /etc/shells
fi

# Set fish as default shell if not in GitHub Codespaces
if [ -z "${CODESPACES:-}" ]; then
    if [ "$SHELL" != "$(which fish)" ]; then
        echo "Setting fish as default shell..."
        chsh -s "$(which fish)"
    fi
else
    echo "Skipping shell change in GitHub Codespaces"
fi

# Install Fisher plugin manager and plugins
echo "Installing Fisher and plugins..."
fish -c "curl -sL https://raw.githubusercontent.com/jorgebucaran/fisher/main/functions/fisher.fish | source && fisher install jorgebucaran/fisher" || true

# Install fish plugins explicitly from fish_plugins file
echo "Installing nvm.fish and other plugins..."
fish -c "fisher install jorgebucaran/nvm.fish PatrickF1/fzf.fish" || true

# Run fisher update to sync with fish_plugins file
fish -c "fisher update" || true

# Install Node Version Manager (nvm) and default version
echo "Setting up Node.js environment..."
if ! command -v node >/dev/null 2>&1; then
    echo "Installing default Node.js version via nvm.fish..."
    # Use the nvm-setup function which respects nvm_default_version
    fish -c "nvm-setup" || {
        echo "Warning: nvm-setup failed, trying manual installation..."
        # Fallback: manually install the default version
        fish -c "nvm install 20.19.4 && nvm use 20.19.4" || true
    }

    # Verify Node.js is available
    if fish -c "type -q node"; then
        echo "Node.js installed successfully"
        # Install common global npm packages
        fish -c "npm install -g npm-check-updates" || true
    else
        echo "Warning: Node.js installation may have failed"
    fi
else
    echo "Node.js already installed: $(node --version)"
fi

echo "Fish shell configuration complete!"